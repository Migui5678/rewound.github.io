<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Failure - Archivo de Serie</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --bg-dark: #0a0a0a;
            --bg-card: #1a1a1a;
            --accent-primary: #00ff88;
            --accent-secondary: #ff0055;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --border-color: #333333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Mono', monospace;
            background: var(--bg-dark);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* P√°gina de inicio */
        #home-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a1a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

        #home-screen.hidden {
            opacity: 0;
            transform: scale(1.1);
            pointer-events: none;
        }

        .title-main {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(4rem, 15vw, 12rem);
            color: var(--text-primary);
            letter-spacing: 0.1em;
            text-align: center;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            text-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
        }

        .title-main:hover {
            color: var(--accent-primary);
            text-shadow: 0 0 50px rgba(0, 255, 136, 0.6);
            transform: scale(1.05);
        }

        .subtitle {
            position: absolute;
            bottom: 10%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9rem;
            color: var(--text-secondary);
            letter-spacing: 0.3em;
            opacity: 0.7;
        }

        /* Aplicaci√≥n principal */
        #app {
            display: none;
            opacity: 0;
            transition: opacity 0.6s ease;
        }

        #app.visible {
            display: flex;
            opacity: 1;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            height: 100vh;
            background: var(--bg-card);
            border-right: 2px solid var(--border-color);
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            z-index: 100;
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 2px solid var(--border-color);
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-card) 100%);
        }

        .sidebar-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            color: var(--accent-primary);
            letter-spacing: 0.15em;
            margin-bottom: 0.5rem;
        }

        .sidebar-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .add-episode-btn, .add-folder-btn {
            flex: 1;
            padding: 0.75rem;
            background: transparent;
            border: 2px solid var(--accent-primary);
            color: var(--accent-primary);
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.1em;
            margin-top: 1rem;
        }

        .add-folder-btn {
            border-color: var(--accent-secondary);
            color: var(--accent-secondary);
        }

        .add-episode-btn:hover {
            background: var(--accent-primary);
            color: var(--bg-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
        }

        .add-folder-btn:hover {
            background: var(--accent-secondary);
            color: var(--bg-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(255, 0, 85, 0.3);
        }

        /* Folders */
        .folder-item {
            border-bottom: 1px solid var(--border-color);
        }

        .folder-header {
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .folder-header:hover {
            background: rgba(255, 0, 85, 0.05);
        }

        .folder-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .folder-item.open .folder-icon {
            transform: rotate(90deg);
        }

        .folder-name {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--accent-secondary);
            letter-spacing: 0.05em;
        }

        .folder-count {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: var(--bg-dark);
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
        }

        .edit-folder-btn, .delete-folder-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
            padding: 0.25rem;
        }

        .folder-header:hover .edit-folder-btn,
        .folder-header:hover .delete-folder-btn {
            opacity: 1;
        }

        .edit-folder-btn:hover {
            color: var(--accent-primary);
        }

        .delete-folder-btn:hover {
            color: var(--accent-secondary);
        }

        .folder-episodes {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .folder-item.open .folder-episodes {
            max-height: 2000px;
        }

        .folder-episodes .episode-item {
            padding-left: 3rem;
            border-left: 3px solid transparent;
        }

        .uncategorized-label {
            padding: 1rem 1.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
        }

        .episodes-list {
            padding: 1rem 0;
        }

        .episode-item {
            padding: 1rem 1.5rem;
            cursor: move;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .episode-item.dragging {
            opacity: 0.5;
            background: rgba(0, 255, 136, 0.1);
        }

        .episode-item.drag-over {
            border-top: 3px solid var(--accent-primary);
        }

        .episode-item:hover {
            background: rgba(0, 255, 136, 0.05);
            border-left-color: var(--accent-primary);
        }

        .episode-item.active {
            background: rgba(0, 255, 136, 0.1);
            border-left-color: var(--accent-primary);
        }

        .episode-number {
            font-size: 0.75rem;
            color: var(--text-secondary);
            letter-spacing: 0.1em;
            margin-bottom: 0.25rem;
        }

        .episode-title {
            font-size: 0.95rem;
            color: var(--text-primary);
            font-weight: 700;
        }

        .edit-episode-btn {
            position: absolute;
            right: 3rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--accent-primary);
            font-size: 1rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .episode-item:hover .edit-episode-btn {
            opacity: 1;
        }

        .move-episode-btn {
            position: absolute;
            right: 5.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .episode-item:hover .move-episode-btn {
            opacity: 1;
        }

        .delete-episode-btn {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--accent-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .episode-item:hover .delete-episode-btn {
            opacity: 1;
        }

        /* Botones para agregar secciones */
        .add-section-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .add-section-btn {
            flex: 1;
            min-width: 150px;
            padding: 0.75rem 1rem;
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.05em;
        }

        .add-section-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: translateY(-2px);
        }

        /* Contenido principal */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            padding: 3rem;
        }

        .episode-header {
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
        }

        .episode-header h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            color: var(--accent-primary);
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .episode-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Editor de contenido */
        .content-section {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 4px;
            cursor: move;
            transition: all 0.3s ease;
        }

        .content-section.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }

        .content-section.drag-over {
            border-color: var(--accent-primary);
            transform: translateY(-5px);
        }

        .section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            color: var(--accent-primary);
            letter-spacing: 0.1em;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 1.5rem;
            background: var(--accent-primary);
        }

        .drag-handle {
            margin-left: auto;
            color: var(--text-secondary);
            cursor: grab;
            font-size: 1.2rem;
            padding: 0.5rem;
            transition: color 0.3s ease;
        }

        .drag-handle:hover {
            color: var(--accent-primary);
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .delete-section-btn {
            margin-left: 0.5rem;
            background: none;
            border: none;
            color: var(--accent-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0.5rem;
        }

        .delete-section-btn:hover {
            color: #ff3366;
            transform: scale(1.2);
        }

        textarea {
            width: 100%;
            min-height: 200px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            padding: 1rem;
            resize: vertical;
            border-radius: 4px;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .file-input-container {
            margin-bottom: 1.5rem;
        }

        .file-input-label {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: 2px solid var(--accent-secondary);
            color: var(--accent-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
        }

        .file-input-label:hover {
            background: var(--accent-secondary);
            color: var(--bg-dark);
            transform: translateY(-2px);
        }

        input[type="file"] {
            display: none;
        }

        /* Galer√≠a de im√°genes */
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .image-item {
            position: relative;
            aspect-ratio: 1;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-item:hover {
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .delete-image-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--accent-secondary);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-size: 1rem;
        }

        .image-item:hover .delete-image-btn {
            opacity: 1;
        }

        /* Audio player */
        .audio-list {
            margin-top: 1rem;
        }

        .audio-item {
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .audio-item audio {
            flex: 1;
            height: 40px;
        }

        .delete-audio-btn {
            background: var(--accent-secondary);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
        }

        /* Modal para vista de imagen */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal img {
            max-width: 90%;
            max-height: 90%;
            border: 3px solid var(--accent-primary);
        }

        .modal-close {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: var(--accent-primary);
            color: var(--bg-dark);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 2rem;
            cursor: pointer;
            font-weight: bold;
        }

        /* Estado vac√≠o */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                border-right: none;
                border-bottom: 2px solid var(--border-color);
            }

            .main-content {
                margin-left: 0;
                padding: 2rem 1rem;
            }

            .title-main {
                font-size: 4rem;
            }
        }
    </style>
</head>
<body>
    <!-- Pantalla de inicio -->
    <div id="home-screen">
        <div>
            <h1 class="title-main" onclick="enterApp()">REWOUND</h1>
            <p class="subtitle">CLICK TO ENTER</p>
        </div>
    </div>

    <!-- Aplicaci√≥n principal -->
    <div id="app">
        <!-- Indicador de guardado -->
        <div class="save-indicator" id="saveIndicator">
            <span class="spinner">‚ü≥</span>
            <span id="saveText">Guardando...</span>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">REWOUND</div>
                <div class="sidebar-buttons">
                    <button class="add-episode-btn" onclick="addEpisode()">+ EPISODIO</button>
                    <button class="add-folder-btn" onclick="addFolder()">+ CARPETA</button>
                </div>
            </div>
            <div class="episodes-list" id="episodesList"></div>
        </aside>

        <!-- Contenido principal -->
        <main class="main-content" id="mainContent">
            <div class="empty-state">
                <h2>Selecciona un episodio o crea uno nuevo</h2>
                <p>Comienza a√±adiendo tu primer episodio desde el men√∫ lateral</p>
            </div>
        </main>
    </div>

    <!-- Modal para vista de imagen -->
    <div class="modal" id="imageModal" onclick="closeModal()">
        <button class="modal-close">√ó</button>
        <img id="modalImage" src="" alt="Vista ampliada">
    </div>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCoz3zzs6gxb9DUdpAX07fs_QoPysWVSa4",
            authDomain: "rewound-bcf31.firebaseapp.com",
            databaseURL: "https://rewound-bcf31-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "rewound-bcf31",
            storageBucket: "rewound-bcf31.firebasestorage.app",
            messagingSenderId: "765226881983",
            appId: "1:765226881983:web:715c3629c6042a0ab9870a"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Estado de la aplicaci√≥n
        let episodes = [];
        let folders = [];
        let currentEpisode = null;
        let isLoading = false;

        // Cargar datos desde Firebase
        async function loadData() {
            try {
                showSaveIndicator('saving');
                
                // Cargar episodios
                const episodesSnapshot = await database.ref('episodes').once('value');
                if (episodesSnapshot.exists()) {
                    episodes = episodesSnapshot.val() || [];
                }
                
                // Cargar carpetas
                const foldersSnapshot = await database.ref('folders').once('value');
                if (foldersSnapshot.exists()) {
                    folders = foldersSnapshot.val() || [];
                }
                
                showSaveIndicator('saved');
            } catch (error) {
                console.error('Error al cargar datos:', error);
                showSaveIndicator('error');
                episodes = [];
                folders = [];
            }
        }

        // Inicializar app
        async function enterApp() {
            document.getElementById('home-screen').classList.add('hidden');
            isLoading = true;
            await loadData();
            isLoading = false;
            setTimeout(() => {
                document.getElementById('app').classList.add('visible');
                renderEpisodesList();
                // Si hay episodios, seleccionar el primero
                if (episodes.length > 0) {
                    selectEpisode(episodes[0].id);
                }
            }, 300);
        }

        // Auto-cargar datos al iniciar la p√°gina
        window.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            // Si hay datos guardados, entrar autom√°ticamente
            if (episodes.length > 0 || folders.length > 0) {
                enterApp();
            }
        });

        // Sincronizaci√≥n en tiempo real con Firebase
        database.ref('episodes').on('value', (snapshot) => {
            if (!isLoading && snapshot.exists()) {
                const newEpisodes = snapshot.val() || [];
                // Solo actualizar si hay cambios
                if (JSON.stringify(newEpisodes) !== JSON.stringify(episodes)) {
                    episodes = newEpisodes;
                    renderEpisodesList();
                    // Refrescar contenido si estamos viendo un episodio
                    if (currentEpisode) {
                        const updated = episodes.find(ep => ep.id === currentEpisode.id);
                        if (updated) {
                            currentEpisode = updated;
                            renderEpisodeContent();
                        }
                    }
                }
            }
        });

        database.ref('folders').on('value', (snapshot) => {
            if (!isLoading && snapshot.exists()) {
                const newFolders = snapshot.val() || [];
                if (JSON.stringify(newFolders) !== JSON.stringify(folders)) {
                    folders = newFolders;
                    renderEpisodesList();
                }
            }
        });

        // A√±adir nuevo episodio
        async function addEpisode(folderId = null) {
            const episodeNumber = episodes.length + 1;
            const title = prompt(`T√≠tulo del Episodio ${episodeNumber}:`) || `Episodio ${episodeNumber}`;
            
            // Calcular el orden dentro de la carpeta
            const episodesInFolder = episodes.filter(ep => ep.folderId === folderId);
            const maxOrder = episodesInFolder.length > 0 
                ? Math.max(...episodesInFolder.map(ep => ep.order || 0))
                : -1;
            
            const newEpisode = {
                id: Date.now(),
                number: episodeNumber,
                title: title,
                sections: [],
                folderId: folderId, // null = sin carpeta
                order: maxOrder + 1 // Orden dentro de la carpeta
            };

            episodes.push(newEpisode);
            await saveEpisodes();
            renderEpisodesList();
            selectEpisode(newEpisode.id);
        }

        // A√±adir nueva carpeta
        async function addFolder() {
            const name = prompt('Nombre de la carpeta:');
            if (!name || !name.trim()) return;

            const newFolder = {
                id: Date.now(),
                name: name.trim(),
                open: true
            };

            folders.push(newFolder);
            await saveFolders();
            renderEpisodesList();
        }

        // Editar nombre de carpeta
        async function editFolderName(folderId) {
            const folder = folders.find(f => f.id === folderId);
            if (!folder) return;

            const newName = prompt('Nuevo nombre de la carpeta:', folder.name);
            if (newName && newName.trim()) {
                folder.name = newName.trim();
                await saveFolders();
                renderEpisodesList();
            }
        }

        // Eliminar carpeta
        async function deleteFolder(folderId) {
            if (!confirm('¬øEliminar esta carpeta? Los episodios dentro se mover√°n a "Sin categor√≠a"')) return;

            // Mover episodios de la carpeta a sin categor√≠a
            episodes.forEach(ep => {
                if (ep.folderId === folderId) {
                    ep.folderId = null;
                }
            });

            folders = folders.filter(f => f.id !== folderId);
            await saveFolders();
            await saveEpisodes();
            renderEpisodesList();
        }

        // Toggle carpeta abierta/cerrada
        function toggleFolder(folderId) {
            const folder = folders.find(f => f.id === folderId);
            if (folder) {
                folder.open = !folder.open;
                saveFolders();
                renderEpisodesList();
            }
        }

        // Mover episodio a carpeta
        async function moveEpisodeToFolder(episodeId) {
            const episode = episodes.find(ep => ep.id === episodeId);
            if (!episode) return;

            let options = '0. Sin categor√≠a\n';
            folders.forEach((folder, index) => {
                options += `${index + 1}. ${folder.name}\n`;
            });

            const choice = prompt(`Mover "${episode.title}" a:\n\n${options}\nIngresa el n√∫mero:`);
            if (choice === null) return;

            const choiceNum = parseInt(choice);
            if (choiceNum === 0) {
                episode.folderId = null;
            } else if (choiceNum > 0 && choiceNum <= folders.length) {
                episode.folderId = folders[choiceNum - 1].id;
            } else {
                alert('Opci√≥n inv√°lida');
                return;
            }

            await saveEpisodes();
            renderEpisodesList();
        }

        // Editar nombre del episodio
        async function editEpisodeTitle(id) {
            const episode = episodes.find(ep => ep.id === id);
            if (!episode) return;

            const newTitle = prompt('Nuevo t√≠tulo del episodio:', episode.title);
            if (newTitle && newTitle.trim()) {
                episode.title = newTitle.trim();
                await saveEpisodes();
                renderEpisodesList();
                if (currentEpisode?.id === id) {
                    renderEpisodeContent();
                }
            }
        }

        // Agregar nueva secci√≥n
        async function addSection(type) {
            if (!currentEpisode) return;

            const sectionId = Date.now();
            const section = {
                id: sectionId,
                type: type,
                data: type === 'notes' ? '' : []
            };

            if (!currentEpisode.sections) {
                currentEpisode.sections = [];
            }

            currentEpisode.sections.push(section);
            await saveEpisodes();
            renderEpisodeContent();
        }

        // Eliminar secci√≥n
        async function deleteSection(sectionId) {
            if (!currentEpisode || !confirm('¬øEliminar esta secci√≥n?')) return;

            currentEpisode.sections = currentEpisode.sections.filter(s => s.id !== sectionId);
            await saveEpisodes();
            renderEpisodeContent();
        }

        // Renderizar lista de episodios con carpetas
        function renderEpisodesList() {
            const list = document.getElementById('episodesList');
            let html = '';

            // Asegurar que todos los episodios tengan orden
            episodes.forEach((ep, index) => {
                if (ep.order === undefined) {
                    ep.order = index;
                }
            });

            // Renderizar carpetas con sus episodios
            folders.forEach(folder => {
                const folderEpisodes = episodes
                    .filter(ep => ep.folderId === folder.id)
                    .sort((a, b) => (a.order || 0) - (b.order || 0));
                
                html += `
                    <div class="folder-item ${folder.open ? 'open' : ''}">
                        <div class="folder-header" onclick="toggleFolder(${folder.id})">
                            <span class="folder-icon">‚ñ∂</span>
                            <span class="folder-name">${folder.name}</span>
                            <span class="folder-count">${folderEpisodes.length}</span>
                            <button class="edit-folder-btn" onclick="event.stopPropagation(); editFolderName(${folder.id})" title="Editar nombre">‚úèÔ∏è</button>
                            <button class="delete-folder-btn" onclick="event.stopPropagation(); deleteFolder(${folder.id})" title="Eliminar carpeta">√ó</button>
                        </div>
                        <div class="folder-episodes" data-folder-id="${folder.id}">
                            ${folderEpisodes.map(ep => `
                                <div class="episode-item ${currentEpisode?.id === ep.id ? 'active' : ''}" 
                                     draggable="true"
                                     data-episode-id="${ep.id}"
                                     onclick="selectEpisode(${ep.id})">
                                    <div class="episode-number">EP. ${ep.number}</div>
                                    <div class="episode-title">${ep.title}</div>
                                    <button class="move-episode-btn" onclick="event.stopPropagation(); moveEpisodeToFolder(${ep.id})" title="Mover a carpeta">üìÅ</button>
                                    <button class="edit-episode-btn" onclick="event.stopPropagation(); editEpisodeTitle(${ep.id})" title="Editar t√≠tulo">‚úèÔ∏è</button>
                                    <button class="delete-episode-btn" onclick="event.stopPropagation(); deleteEpisode(${ep.id})" title="Eliminar episodio">√ó</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            // Episodios sin carpeta
            const uncategorizedEpisodes = episodes
                .filter(ep => !ep.folderId)
                .sort((a, b) => (a.order || 0) - (b.order || 0));
                
            if (uncategorizedEpisodes.length > 0) {
                html += '<div class="uncategorized-label">Sin categor√≠a</div>';
                html += '<div class="uncategorized-container" data-folder-id="null">';
                uncategorizedEpisodes.forEach(ep => {
                    html += `
                        <div class="episode-item ${currentEpisode?.id === ep.id ? 'active' : ''}" 
                             draggable="true"
                             data-episode-id="${ep.id}"
                             onclick="selectEpisode(${ep.id})">
                            <div class="episode-number">EP. ${ep.number}</div>
                            <div class="episode-title">${ep.title}</div>
                            <button class="move-episode-btn" onclick="event.stopPropagation(); moveEpisodeToFolder(${ep.id})" title="Mover a carpeta">üìÅ</button>
                            <button class="edit-episode-btn" onclick="event.stopPropagation(); editEpisodeTitle(${ep.id})" title="Editar t√≠tulo">‚úèÔ∏è</button>
                            <button class="delete-episode-btn" onclick="event.stopPropagation(); deleteEpisode(${ep.id})" title="Eliminar episodio">√ó</button>
                        </div>
                    `;
                });
                html += '</div>';
            }

            list.innerHTML = html || '<div class="empty-state" style="padding: 2rem 1rem;"><p style="color: var(--text-secondary); font-size: 0.85rem;">Agrega tu primer episodio o carpeta</p></div>';
            
            // Configurar drag and drop para episodios
            setupEpisodeDragAndDrop();
        }

        // Configurar drag and drop para reordenar episodios
        function setupEpisodeDragAndDrop() {
            const episodeItems = document.querySelectorAll('.episode-item');
            let draggedEpisode = null;

            episodeItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedEpisode = item;
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', (e) => {
                    item.classList.remove('dragging');
                    draggedEpisode = null;
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    
                    if (draggedEpisode && draggedEpisode !== item) {
                        // Remover clase de todos
                        document.querySelectorAll('.episode-item').forEach(el => {
                            el.classList.remove('drag-over');
                        });
                        item.classList.add('drag-over');
                    }
                });

                item.addEventListener('dragleave', (e) => {
                    item.classList.remove('drag-over');
                });

                item.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    item.classList.remove('drag-over');
                    
                    if (!draggedEpisode || draggedEpisode === item) return;

                    const draggedId = parseInt(draggedEpisode.getAttribute('data-episode-id'));
                    const targetId = parseInt(item.getAttribute('data-episode-id'));
                    
                    const draggedEp = episodes.find(ep => ep.id === draggedId);
                    const targetEp = episodes.find(ep => ep.id === targetId);

                    if (!draggedEp || !targetEp) return;

                    // Solo reordenar si est√°n en la misma carpeta
                    if (draggedEp.folderId === targetEp.folderId) {
                        await reorderEpisodes(draggedId, targetId, draggedEp.folderId);
                    }
                });
            });
        }

        // Reordenar episodios
        async function reorderEpisodes(draggedId, targetId, folderId) {
            const folderEpisodes = episodes
                .filter(ep => ep.folderId === folderId)
                .sort((a, b) => (a.order || 0) - (b.order || 0));

            const draggedIndex = folderEpisodes.findIndex(ep => ep.id === draggedId);
            const targetIndex = folderEpisodes.findIndex(ep => ep.id === targetId);

            if (draggedIndex === -1 || targetIndex === -1) return;

            // Remover el episodio arrastrado
            const [draggedEpisode] = folderEpisodes.splice(draggedIndex, 1);
            
            // Insertar en la nueva posici√≥n
            folderEpisodes.splice(targetIndex, 0, draggedEpisode);

            // Actualizar el orden de todos los episodios en la carpeta
            folderEpisodes.forEach((ep, index) => {
                ep.order = index;
            });

            await saveEpisodes();
            renderEpisodesList();
        }

        // Seleccionar episodio
        function selectEpisode(id) {
            currentEpisode = episodes.find(ep => ep.id === id);
            renderEpisodesList();
            renderEpisodeContent();
        }

        // Renderizar contenido del episodio
        function renderEpisodeContent() {
            const content = document.getElementById('mainContent');
            
            if (!currentEpisode) {
                content.innerHTML = `
                    <div class="empty-state">
                        <h2>Selecciona un episodio o crea uno nuevo</h2>
                        <p>Comienza a√±adiendo tu primer episodio desde el men√∫ lateral</p>
                    </div>
                `;
                return;
            }

            // Asegurar que existe el array de secciones
            if (!currentEpisode.sections) {
                currentEpisode.sections = [];
            }

            // Generar HTML para cada secci√≥n
            let sectionsHTML = '';
            currentEpisode.sections.forEach(section => {
                sectionsHTML += generateSectionHTML(section);
            });

            content.innerHTML = `
                <div class="episode-header">
                    <h1>Episodio ${currentEpisode.number}: ${currentEpisode.title}</h1>
                    <p>Arrastra las secciones para reordenarlas</p>
                </div>

                <div class="add-section-container">
                    <button class="add-section-btn" onclick="addSection('notes')">+ A√ëADIR NOTAS</button>
                    <button class="add-section-btn" onclick="addSection('images')">+ A√ëADIR IM√ÅGENES</button>
                    <button class="add-section-btn" onclick="addSection('audio')">+ A√ëADIR AUDIO</button>
                </div>

                <div id="sectionsContainer">
                    ${sectionsHTML || '<div class="empty-state"><p>Agrega tu primera secci√≥n usando los botones de arriba</p></div>'}
                </div>
            `;

            // Configurar eventos para cada secci√≥n
            setupSectionEvents();
            setupDragAndDrop();
        }

        // Generar HTML para una secci√≥n seg√∫n su tipo
        function generateSectionHTML(section) {
            const sectionTypeNames = {
                notes: 'Notas y Apuntes',
                images: 'Im√°genes',
                audio: 'Audio'
            };

            let contentHTML = '';
            
            if (section.type === 'notes') {
                contentHTML = `
                    <textarea class="section-textarea" data-section-id="${section.id}" placeholder="Escribe tus notas aqu√≠...">${section.data || ''}</textarea>
                `;
            } else if (section.type === 'images') {
                contentHTML = `
                    <div class="file-input-container">
                        <label class="file-input-label" for="imageInput-${section.id}">
                            üì∑ SUBIR IM√ÅGENES
                        </label>
                        <input type="file" id="imageInput-${section.id}" class="image-input" data-section-id="${section.id}" accept="image/*" multiple>
                    </div>
                    <div class="images-grid" id="imagesGrid-${section.id}">
                        ${generateImagesHTML(section)}
                    </div>
                `;
            } else if (section.type === 'audio') {
                contentHTML = `
                    <div class="file-input-container">
                        <label class="file-input-label" for="audioInput-${section.id}">
                            üéµ SUBIR AUDIO
                        </label>
                        <input type="file" id="audioInput-${section.id}" class="audio-input" data-section-id="${section.id}" accept="audio/*" multiple>
                    </div>
                    <div class="audio-list" id="audioList-${section.id}">
                        ${generateAudioHTML(section)}
                    </div>
                `;
            }

            return `
                <div class="content-section" draggable="true" data-section-id="${section.id}">
                    <div class="section-title">
                        ${sectionTypeNames[section.type]}
                        <span class="drag-handle" title="Arrastra para reordenar">‚ãÆ‚ãÆ</span>
                        <button class="delete-section-btn" onclick="deleteSection(${section.id})" title="Eliminar secci√≥n">√ó</button>
                    </div>
                    ${contentHTML}
                </div>
            `;
        }

        // Generar HTML para im√°genes de una secci√≥n
        function generateImagesHTML(section) {
            if (!section.data || !section.data.length) {
                return '<p style="color: var(--text-secondary);">No hay im√°genes todav√≠a</p>';
            }

            return section.data.map((img, index) => `
                <div class="image-item" onclick="openModal('${img}')">
                    <img src="${img}" alt="Imagen ${index + 1}">
                    <button class="delete-image-btn" onclick="event.stopPropagation(); deleteItemFromSection(${section.id}, ${index})">√ó</button>
                </div>
            `).join('');
        }

        // Generar HTML para audio de una secci√≥n
        function generateAudioHTML(section) {
            if (!section.data || !section.data.length) {
                return '<p style="color: var(--text-secondary);">No hay audio todav√≠a</p>';
            }

            return section.data.map((audio, index) => `
                <div class="audio-item">
                    <audio controls src="${audio.data}"></audio>
                    <button class="delete-audio-btn" onclick="deleteItemFromSection(${section.id}, ${index})">√ó</button>
                </div>
            `).join('');
        }

        // Configurar eventos para las secciones
        let autoSaveTimeout = null;
        function setupSectionEvents() {
            // Eventos de textarea para notas con debounce
            document.querySelectorAll('.section-textarea').forEach(textarea => {
                textarea.addEventListener('input', (e) => {
                    const sectionId = parseInt(e.target.getAttribute('data-section-id'));
                    const section = currentEpisode.sections.find(s => s.id === sectionId);
                    if (section) {
                        section.data = e.target.value;
                        
                        // Debounce: guardar medio segundo despu√©s de dejar de escribir
                        clearTimeout(autoSaveTimeout);
                        showSaveIndicator('saving');
                        autoSaveTimeout = setTimeout(async () => {
                            await saveEpisodes();
                        }, 500);
                    }
                });
            });

            // Eventos de input para im√°genes
            document.querySelectorAll('.image-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const sectionId = parseInt(e.target.getAttribute('data-section-id'));
                    handleFileUpload(e, sectionId, 'image');
                });
            });

            // Eventos de input para audio
            document.querySelectorAll('.audio-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const sectionId = parseInt(e.target.getAttribute('data-section-id'));
                    handleFileUpload(e, sectionId, 'audio');
                });
            });
        }

        // Manejar carga de archivos (im√°genes y audio)
        function handleFileUpload(event, sectionId, fileType) {
            const section = currentEpisode.sections.find(s => s.id === sectionId);
            if (!section) return;

            const files = Array.from(event.target.files);
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    if (fileType === 'image') {
                        section.data.push(e.target.result);
                    } else if (fileType === 'audio') {
                        section.data.push({
                            name: file.name,
                            data: e.target.result
                        });
                    }
                    await saveEpisodes();
                    renderEpisodeContent();
                };
                reader.readAsDataURL(file);
            });

            event.target.value = '';
        }

        // Eliminar item de una secci√≥n (imagen o audio)
        async function deleteItemFromSection(sectionId, index) {
            if (!confirm('¬øEliminar este elemento?')) return;

            const section = currentEpisode.sections.find(s => s.id === sectionId);
            if (section && section.data) {
                section.data.splice(index, 1);
                await saveEpisodes();
                renderEpisodeContent();
            }
        }

        // Configurar drag and drop para reordenar secciones
        function setupDragAndDrop() {
            const container = document.getElementById('sectionsContainer');
            if (!container) return;

            const sections = container.querySelectorAll('.content-section');
            let draggedElement = null;

            sections.forEach(section => {
                section.addEventListener('dragstart', (e) => {
                    draggedElement = section;
                    section.classList.add('dragging');
                });

                section.addEventListener('dragend', (e) => {
                    section.classList.remove('dragging');
                    draggedElement = null;
                });

                section.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(container, e.clientY);
                    if (afterElement == null) {
                        container.appendChild(draggedElement);
                    } else {
                        container.insertBefore(draggedElement, afterElement);
                    }
                });

                section.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    // Actualizar el orden en el modelo
                    const newOrder = Array.from(container.querySelectorAll('.content-section'))
                        .map(el => parseInt(el.getAttribute('data-section-id')));
                    
                    // Reordenar el array de secciones
                    const orderedSections = [];
                    newOrder.forEach(id => {
                        const section = currentEpisode.sections.find(s => s.id === id);
                        if (section) orderedSections.push(section);
                    });
                    currentEpisode.sections = orderedSections;
                    await saveEpisodes();
                });
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.content-section:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Modal de imagen
        function openModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        // Eliminar episodio
        async function deleteEpisode(id) {
            if (confirm('¬øEliminar este episodio?')) {
                episodes = episodes.filter(ep => ep.id !== id);
                
                // Renumerar episodios
                episodes.forEach((ep, index) => {
                    ep.number = index + 1;
                });

                if (currentEpisode?.id === id) {
                    currentEpisode = null;
                }

                await saveEpisodes();
                renderEpisodesList();
                renderEpisodeContent();
            }
        }

        // Mostrar indicador de guardado
        let saveTimeout = null;
        function showSaveIndicator(status = 'saving') {
            const indicator = document.getElementById('saveIndicator');
            const text = document.getElementById('saveText');
            
            if (!indicator) return;

            indicator.classList.remove('saving', 'error');
            
            if (status === 'saving') {
                indicator.classList.add('saving', 'show');
                text.textContent = 'Guardando...';
            } else if (status === 'saved') {
                indicator.classList.add('show');
                text.textContent = '‚úì Guardado';
                
                // Ocultar despu√©s de 2 segundos
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            } else if (status === 'error') {
                indicator.classList.add('error', 'show');
                text.textContent = '‚úó Error al guardar';
                
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    indicator.classList.remove('show');
                }, 3000);
            }
        }

        // Guardar episodios en Firebase
        async function saveEpisodes() {
            showSaveIndicator('saving');
            try {
                await database.ref('episodes').set(episodes);
                showSaveIndicator('saved');
            } catch (error) {
                console.error('Error al guardar:', error);
                showSaveIndicator('error');
                alert('Hubo un error al guardar los cambios. Por favor, intenta de nuevo.');
            }
        }

        // Guardar carpetas en Firebase
        async function saveFolders() {
            showSaveIndicator('saving');
            try {
                await database.ref('folders').set(folders);
                showSaveIndicator('saved');
            } catch (error) {
                console.error('Error al guardar carpetas:', error);
                showSaveIndicator('error');
            }
        }
    </script>
</body>
</html>
